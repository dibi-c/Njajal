<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMS LITE - High Stability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;800&family=JetBrains+Mono:wght@700&display=swap');
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #0a0c10; color: #94a3b8; 
            min-height: 100vh; margin: 0; padding: 10px;
        }
        .v-mono { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        .card { background: #11141b; border: 1px solid #1e293b; border-radius: 16px; padding: 12px; }
        .label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; }
        .status-on { color: #10b981; border-color: #064e3b; background: rgba(16, 185, 129, 0.05); }
        .status-off { color: #475569; border-color: #1e293b; }
        .reconnect-anim { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .3; } }
    </style>
</head>
<body>

    <div class="max-w-xl mx-auto space-y-3">
        <div class="flex justify-between items-center px-1">
            <h1 class="text-lg font-black text-white italic">CORE<span class="text-blue-500">BMS</span> <span class="text-[10px] opacity-40 font-normal ml-2">v7.0 LITE</span></h1>
            <div class="flex gap-2">
                <button onclick="openCfg()" class="text-xs font-bold bg-white/5 px-3 py-2 rounded-lg">CFG</button>
                <button id="connectBtn" class="bg-blue-600 text-white text-[10px] px-4 py-2 rounded-lg font-black uppercase">Connect</button>
            </div>
        </div>

        <div class="card flex flex-col items-center py-8">
            <span class="label">State of Charge</span>
            <div class="flex items-baseline">
                <span id="soc" class="text-8xl font-black text-white tracking-tighter">0</span>
                <span class="text-2xl font-bold text-blue-500 ml-1">%</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div class="card">
                <span class="label">Total Voltage</span>
                <p id="vTotal" class="v-mono text-2xl text-white">0.00V</p>
            </div>
            <div class="card">
                <span class="label">Current</span>
                <p id="current" class="v-mono text-2xl text-orange-400">0.00A</p>
            </div>
            <div class="card">
                <span class="label">Power</span>
                <p id="power" class="v-mono text-2xl text-blue-400">0W</p>
            </div>
            <div class="card">
                <span class="label">Battery Temp</span>
                <p id="tBatt" class="v-mono text-2xl text-emerald-400">0°C</p>
            </div>
        </div>

        <div class="card space-y-3">
            <div class="flex justify-between items-center border-b border-white/5 pb-2">
                <span id="errText" class="text-[10px] font-black uppercase tracking-widest text-emerald-500">System Ready</span>
                <span id="lastSync" class="v-mono text-[9px]">--:--:--</span>
            </div>
            <div class="grid grid-cols-4 gap-2">
                <div class="text-center bg-black/20 py-1 rounded-md"><p class="label !text-[8px]">C1</p><p id="v1" class="v-mono text-[10px] text-white">0.00</p></div>
                <div class="text-center bg-black/20 py-1 rounded-md"><p class="label !text-[8px]">C2</p><p id="v2" class="v-mono text-[10px] text-white">0.00</p></div>
                <div class="text-center bg-black/20 py-1 rounded-md"><p class="label !text-[8px]">C3</p><p id="v3" class="v-mono text-[10px] text-white">0.00</p></div>
                <div class="text-center bg-black/20 py-1 rounded-md"><p class="label !text-[8px]">C4</p><p id="v4" class="v-mono text-[10px] text-white">0.00</p></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div id="rChg" class="card text-center border !py-2 text-[9px] font-bold uppercase status-off">Charging</div>
            <div id="rDis" class="card text-center border !py-2 text-[9px] font-bold uppercase status-off">Discharging</div>
        </div>
        
        <div class="text-center">
            <p id="syncBadge" class="text-[8px] font-bold opacity-30">CLOUD SYNC READY</p>
        </div>
    </div>

    <div id="configModal" class="hidden fixed inset-0 bg-black/95 flex items-center justify-center p-6 z-50">
        <div class="card w-full max-w-sm">
            <h2 class="label mb-4 text-white">Firebase JSON</h2>
            <textarea id="fbInput" class="w-full h-32 bg-black text-emerald-500 p-2 text-[10px] rounded-lg mb-4 v-mono outline-none border border-white/10"></textarea>
            <div class="flex gap-2">
                <button onclick="saveCfg()" class="flex-1 bg-blue-600 p-3 rounded-lg text-xs font-bold text-white uppercase">Save</button>
                <button onclick="closeCfg()" class="flex-1 bg-white/5 p-3 rounded-lg text-xs font-bold uppercase">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // CONFIG & DB
        const db = new Dexie("BMS_LITE_DB");
        db.version(1).stores({ logs: '++id, ts, synced' });
        let rtdb = null;
        const saved = localStorage.getItem('bms_v48_cloud');
        if(saved) try { rtdb = getDatabase(initializeApp(JSON.parse(saved))); } catch(e) {}

        // STATE
        let device = null, txChar, rxChar;
        let buffer = new Uint8Array(0);
        let lastSampleTime = 0, lastDataReceived = Date.now();
        let pollActive = false, secondsPassed = 0;
        window.bmsState = { v:0, a:0, p:0, soc:0, tB:0, rC:0, rD:0, err:0 };

        // UI HELPERS
        const uEl = (id, v) => { const e = document.getElementById(id); if(e && e.innerText !== String(v)) e.innerText = v; };
        const relay = (id, v) => {
            const e = document.getElementById(id);
            if(e) e.className = v > 0.5 ? "card text-center border !py-2 text-[9px] font-bold uppercase status-on" : "card text-center border !py-2 text-[9px] font-bold uppercase status-off";
        };

        // PARSER
        function parse(pkt, head) {
            const data = pkt.slice(1, -1);
            const dv = new DataView(data.buffer, data.byteOffset, data.byteLength);
            const f = [];
            if (head !== 0xEE) for (let i = 0; i + 4 <= data.length; i += 4) f.push(dv.getFloat32(i, true));

            if (head === 0xAA) { 
                uEl('vTotal', f[0].toFixed(2) + 'V'); uEl('soc', f[8].toFixed(0));
                uEl('current', f[5].toFixed(2) + 'A'); uEl('power', f[6].toFixed(0) + 'W');
                uEl('v1', f[1].toFixed(2)); uEl('v2', f[2].toFixed(2));
                uEl('v3', f[3].toFixed(2)); uEl('v4', f[4].toFixed(2));
                Object.assign(window.bmsState, { v:f[0], a:f[5], p:f[6], soc:f[8] });
            } 
            else if (head === 0xCC) {
                uEl('tBatt', f[1].toFixed(1) + '°C'); relay('rChg', f[5]); relay('rDis', f[6]);
                window.bmsState.tB = f[1];
            }
            else if (head === 0xEE) {
                const isErr = pkt[1] > 0;
                uEl('errText', isErr ? "ALARM ACTIVE" : "SYSTEM SECURE");
                document.getElementById('errText').className = isErr ? "text-[10px] font-black uppercase text-red-500 animate-pulse" : "text-[10px] font-black uppercase text-emerald-500";
                window.bmsState.err = pkt[1];
            }
            uEl('lastSync', new Date().toLocaleTimeString('id-ID', {hour12:false}));
            lastDataReceived = Date.now();
            handleTelemetry();
        }

        // TELEMETRY & CLOUD
        async function handleTelemetry() {
            const ts = Date.now();
            if(rtdb) set(ref(rtdb, 'bms_live'), { ...window.bmsState, ts }).catch(()=>{});
            if (ts - lastSampleTime >= 5000) {
                lastSampleTime = ts;
                await db.logs.add({ ts, a:window.bmsState.a, v:window.bmsState.v, synced:0 });
                if(navigator.onLine && rtdb) {
                    const logs = await db.logs.where('synced').equals(0).limit(5).toArray();
                    for(let l of logs) { await push(ref(rtdb, 'bms_history'), l); await db.logs.delete(l.id); }
                }
            }
        }

        // BLUETOOTH & POLLING
        const send = async (s) => {
            if(!txChar || !device?.gatt?.connected) return;
            const c = new Uint8Array([0xBB, s.charCodeAt(0), s.charCodeAt(1), 0xBB ^ s.charCodeAt(0) ^ s.charCodeAt(1)]);
            try { await txChar.writeValueWithResponse(c); } catch(e) {}
        };

        const poll = async () => {
            if (pollActive && (Date.now() - lastDataReceived > 20000)) { handleDisconnect(); return; }
            if(!pollActive || !device?.gatt?.connected) return;
            try {
                await send('VA');
                if (secondsPassed % 5 === 0) await send('PT');
                if (secondsPassed % 10 === 0) await send('ER');
                secondsPassed = (secondsPassed + 1) % 60;
            } catch(e) {} finally { setTimeout(poll, 1000); }
        };

        async function connect() {
            try {
                if(!device) {
                    device = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices:['0000ffe0-0000-1000-8000-00805f9b34fb'] });
                    device.addEventListener('gattserverdisconnected', handleDisconnect);
                }
                if(device.gatt.connected) return;
                const srv = await device.gatt.connect();
                const svc = await srv.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                rxChar = await svc.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
                txChar = await svc.getCharacteristic('0000ffe2-0000-1000-8000-00805f9b34fb');
                
                rxChar.addEventListener('characteristicvaluechanged', (e) => {
                    const chunk = new Uint8Array(e.target.value.buffer);
                    let combined = new Uint8Array(buffer.length + chunk.length);
                    combined.set(buffer); combined.set(chunk, buffer.length);
                    buffer = combined;
                    while(buffer.length > 0) {
                        const h = buffer[0];
                        let len = (h===0xAA)?46:(h===0xCC)?50:(h===0xEE)?8:0;
                        if(len===0 || h<0xAA) { buffer=buffer.slice(1); continue; }
                        if(buffer.length < len) break;
                        parse(buffer.slice(0, len), h);
                        buffer = buffer.slice(len);
                    }
                    if(buffer.length > 256) buffer = new Uint8Array(0);
                });
                await rxChar.startNotifications();
                pollActive = true; lastDataReceived = Date.now();
                const b = document.getElementById('connectBtn');
                b.innerText = "CONNECTED"; b.className = "bg-emerald-600 text-white text-[10px] px-4 py-2 rounded-lg font-black uppercase";
                poll();
                if ('wakeLock' in navigator) await navigator.wakeLock.request('screen');
            } catch(e) { handleDisconnect(); }
        }

        function handleDisconnect() {
            pollActive = false;
            const b = document.getElementById('connectBtn');
            b.innerText = "RECONNECTING..."; b.className = "bg-red-600 reconnect-anim text-white text-[10px] px-4 py-2 rounded-lg font-black uppercase";
            setTimeout(() => { if(!pollActive) connect(); }, 5000);
        }

        document.getElementById('connectBtn').onclick = connect;
        window.openCfg = () => document.getElementById('configModal').classList.remove('hidden');
        window.closeCfg = () => document.getElementById('configModal').classList.add('hidden');
        window.saveCfg = () => { localStorage.setItem('bms_v48_cloud', document.getElementById('fbInput').value); location.reload(); };
    </script>
</body>
</html>
